					检测 ARP 欺骗攻击 ：主动防御技术
					Vivek Ramachandran1 and Sukumar Nandi2
					Cisco Systems, Inc., Bangalore India
	摘要. 由于地址解析协议（ARP）的无状态性和缺乏对发送者的身份验证机制，已长期被用于ARP欺骗攻击。
有时候APR欺骗攻击通常是针对于复杂局域网进行攻击类似于拒绝服务、中间人攻击和会话劫持。当前监测ARP欺骗
攻击用的都是些被动方式，监测局域网中的ARP报文查找易变的以太网地址和IP映射。被动防御方式的主要缺点在于
APR学习和检测到攻击的时差，有时会导致在攻击进行很长一段时间后才被发现。在这篇论文中，我们给出一个主动
监测ARP欺骗攻击的技术。我们注入ARP请求报文和TCP SYN报文到网络中来探测不正常的MAC地址与IP映射。这种技术
相比于被动防御方式更快、更智能、扩展性更强，在监测ARP攻击上更可靠。这种技术能够检测到正确的MAC和IP的映射
关系从而增加ARP攻击被检测出来的精确及可靠性。
1 介绍
	ARP协议是局域网内最基础但是非常重要的通信协议之一。ARP协议用来解析MAC地址与主机IP的对应关系。这是通过
发送特定ARP请求报文（广播）到网络中来完成。相对应的主机回复携带自己正确的MAC地址与IP的ARP应答报文（单播）。
在某些情况下主机会发送ARP报文广播自己的MAC地址。所有的主机都会维护一份ARP缓存保存从网络上学习到的（动态项（
MAC的地址映射或是管理员配置的映射关系（静态项）。动态项会在一定的时间后过期，这个过期时间因操作系统的实现
方式不同而不同。在这些条目过期之后会从ARP缓存中删除，如果此时主机想于其他在同一局域网内机器通信，额外的ARP
请求报文会发出去。静态项永远不会过期。针对ARP协议的更详细讨论详见［1］。
	ARP协议是无状态的，主机会缓存所有发送给他的ARP应答消息即使不是明确请求的ARP应答。在大多数操作系统中即使
是之前的没有过期的动态ARP表项会被新来的ARP报文携带的信息覆盖。由于没有采取任何验证机制，所有的主机盲目的缓
存收到的ARP应答，这才是导致ARP欺骗攻击发生的根源。
	ARP欺骗是伪造受害者主机构造ARP报文发送到局域网中。在最常见的ARP攻击形式中，攻击者会周期性的发送ARP
应答报文欺骗受害者主机。这会保证局域网中的其它机器永远不会发送ARP请求报文去请求被攻击的主机的IP与地址映射
关系。下面一节将简短的讨论当前检测和预防ARP攻击技术。
1.1 时下缓和及侦测技术
	现存的ARP欺骗检测技巧在下面几个小结将被讨论。
1.1.1 安全 ARP 协议（S-ARP）
	这已经被建议作为现存ARP协议的替代协议，详见［10］. S-ARP是定义为一个永久ARP欺骗攻击解决方案，但是最大的
缺点是我们必须更改网络上所有主机的协议栈。这并不是高可扩展的解决方案去让所有操作系统和硬件提供商及所有的客户
去升级他们系统，他们不会乐于这样做。由于S-ARP使用了数字签名算法（DSA）我们还有其它的很多任务要去看一些
关于加密的论文，不过在这里介绍显然是没意义的。
1.1.2 静态MAC项
	为每一台主机增加静态MAC地址项就不会有任何欺骗攻击的存在，但是这种解决方案在管理所有静态项的时工作量太大。
而其这种方式很不幸的在大量移动主机不定期介入的时侯更不可行，例如笔记本。一些操作系统在收到自主ARP报文（GARP）
的时候会更新静态ARP项。
1.1.3 基于内核补丁
	基于内核的补丁，像Anticap［11］和Antidote［12］已经对ARP欺骗攻击在自身主机层面进行保护。Anticap［11］
在接收到承载不同的MAC与IP映射ARP应答报文的时候不允许更新没有过期的ARP缓存这个很不幸的让合法自主ARP报文也被
丢弃，这违反了ARP协议的一些特性［1］，Antidote［12］在接收到一个ARP应答报文的时候如果报文承载的内容和之前
缓存的内容不同的花就会尝试检查之前学习到的MAC是否依然存活。如果之前学习到的MAC地址依然存在就拒绝更新缓存
而其将违规的MAC地址加入到地址黑名单中。
	以上两种技术依赖于ARP缓存中的映射关系合法的情况下。这就在攻击者和受害者之前产生了一个竞争关系。如果
攻击者攻击者让其伪造的ARP项进入到主机缓存先于真实项，那么真实MAC地址就会被禁止。这种情况发生只能在系统
管理员的干涉下才能解决。因此我们可以得处错误的学习方式可能会导致这些攻击在检测ARP攻击时候失败。
1.1.4 被动检测
	在被动检测中，我们嗅探到网络上的ARP请求/应答包然后建立MAC与IP映射关系库。如果我们注意到任何MAC地址和
IP映射关系的变化后就开始报警认为ARP欺骗攻击正在进行。用这种方法实现的最著名的工具是ARPWATCH［9］。
	被动检测的主要缺点在于学习地址映射关系和检测到攻击的时差。第一次在工具运行之前攻击已经开始的情况下
检测工具会学习到虚假的ARP应答报文将虚假的MAC与IP映射关系入库。现在只有在受害者开始与其它主机通信的时候
MAC与IP对应关系的不一致才会被发现，报警才会出现。攻击着可能利用这个时差已经逃离。上述场景中学习到
的虚假ARP项将不得不由网络管理员手动解除才行。解决这个问题的唯一方式之后手动的去纠正并录入正确的地址映射
关系到数据库中在启动ARP欺骗攻击检测工具之前。所有的这些无论是在扩展性还是灵活性上都是不合理的。一个典型
的例子是移动设备介入，例如来公司的客户或参观者携带的笔记本。这样慢的学习曲线导致不可能在一个大型网路中
（1000+ hosts）安装被动检测工具并同时希望能检测出攻击的存在。
	被动检测技术一点也不智能，盲目的查找网络中的ARP应答与本地数据库中不匹配的ARP表项。如果ARP攻击被检测
到也没有办法查明最新看到的MAC与IP映射是真是假，因为无法保证之前学习到的映射关系的真假。我们的技术将会
得到真实的MAC和IP的对应关系即使在攻击进行中，从而给保证了检测的准确性。
	被动学习技术也非常不可靠。在ARP流量被看见的时候一个新地址映射关系会被学习。因此一个交换机的ARP缓
存在存储大量条目后会溢出。攻击者每秒尝试产生随机的ARP应答包承载任意的MAC和IP地址映射，这将会导致缓存
溢出而非汇报攻击的出现。为了克服早期防疫技术的缺陷，我们给出一个新的ARP欺骗攻击见车技术。我们的技术
采取主动方式去检测ARP欺骗攻击。我们发送我们的ARP请求和TCP SYN包来探测网络上ARP流量的合法性。这种方式
相比于被动方式更快，更智能，扩展性更强也更可靠。也能附加的检测到正确的IP与MAC的映射关系从而增加侦测到
真实攻击的准确性。接下来的几节将会用来描述这个技术。
2 主动监测ARP欺骗技术的建议
	这个建议的技术与现存的ARP攻击方式有很强的相关性。从今以后我们会假设我嫩的网络需要保护。
2.1 一些假设
1. 攻击者的计算机有正常的网络协议栈。这个假设是基于大多数攻击是用“即用”ARP攻击攻击［8］进行的，这是
非常受攻击者欢迎的手段。如果攻击者真用一个定制化的协议栈那么我们的的技术将不再能够监测出正确的MAC
与ARP关系。我们将会在2.5节中讨论此技术在现存的定制化协议栈中的表现。
2. 如果我们要在网络上保护我们的个人主机我们可能会用一个个人防火墙但是至少会有一个TCP端口是对外开放
的，防火墙允许流量从此端口通过。这将允许我们的探测报文（TCP SYN 包）能够通过。这是一个合理的假设
即使防火墙安装在基础网络架构上，作为基础服务，例如NETBIOS等是常见的允许局域网通信的基础服务。
3.我们假设所有的受保护的设备运行着TCP/IP网络协议栈。
2.2 术语
	现在我们介绍在这篇论文的余下部分可能会用到的一些术语
    1. 阈值区间：针对于一个ARP请求的ARP应答必须在一定的时间间隔内被接收。在这个时间过去后我们会认为这个ARP
请求已经”过期“。我们称这个时间间隔为”阈值区间“。这项在我们的技术中是可配的。
	2. 主机数据库：这个是用来存储所有在网络上用我们的技术学习到的合法的IP和MAC地址映射关系。
	ARP报文由MAC头部和ARP头部组成。基于在MAC头部的源MAC地址和目的MAC地址以及在ARP头部中的建议可以将所有
的ARP报文分成两类。
		1. 非持久性头部ARP包：MAC地址在MAC和ARP头部不同例如 在MAC头部的MAC地址 ！= ARP头部的源MAC地址（
在（ARP 请求/应答）或者在MAC头部目的MAC地址！=在ARP头部的目的地址（仅仅针对 ARP应答）。
		2. 持久性头部ARP包：这与非持久性头部ARP报文相反，在MAC头部的MAC地址一在ARP头部的MAC地址一致。
		注意非持久头部的ARP报文一定是伪造的欺骗报文，因为像这样异常只可能在攻击情况下出现。基于以上结论
	我们可以进一步将持久性头部分成一下三类：
		1.满ARP请求环：一个ARP请求报文和在阈值区间内收到ARP应答报文。
		2.半请求环：一个ARP请求报文发出去后在阈值区间内没有收到ARP应答报文。
		3.半应答环：一个ARP应答消息在没有请求的情况下产生并到达。

		这三种类型形成了我们监测ARP攻击的基本机制。接下来的几小节将会讨论此技术的技术及架构细节。
2.3 架构
	对于技术架构细节的讨论请参考图 1 。我们已经采取了模块化设计方法将我嫩的攻击监测方法分成以下模块：
		1. ARP嗅探模块：此模块将从网络上嗅探到ARP流量

		2.MAC-ARP 异常头部监测模块： 这个模块将ARP流量分为持久头部ARP报文和非持久性头部ARP报文。、

		3.流量过滤模块：这将对所有已经嗅探到的流量进行过滤。会丢弃一些携带数据和数据库中结果一样的报文
		或者产生报警如果学习到的映射关系与数据库中已知的正确结果冲突的报文。所有携带新的结果的ARP报文
		会由欺骗监测引擎来验证。

		4.欺骗监测引擎模块：这是主要的监测引擎。我们将之久头部ARP报文作为他的输入，这个模块的设计将会在2.4节
		进行讨论。

		5.数据库存储模块：这个模块会在监测到ARP欺骗攻击后向管理员发送报警或邮件，SMS等

	如图一所示，这个ARP嗅探模块从网络中嗅探到所有发送到本机网卡上的ARP流量-进行ARP 头部异常监测。这个模块
会将所有的持久化头部的ARP报文传给过滤模块。所有的非持久化将被发送到欺骗警报模块。这是因为所有的非持久化
ARP报文全部都是ARP欺骗报文就像之前讨论的那样。流量过滤模块将会移除所有的携带数据与数据库中相同的报文。
如果有报文携带的内容与数据库中发生冲突的话就会报警。最后所有剩下的ARP报文会导入欺骗监测引擎。
	图一
	blalalalalalalalalalalalal
	Fig. 1. Inter-relation between various Modules used by the ARP Spoof Detection Algorithm
	ARP欺骗监测引擎会用我们的监测算法来监测ARP欺骗攻击。新学习到的持久头部ARP报文会输入到这个模块中。
在2.2节讨论过引擎会在内部将这些报文分成三类，也就是 满ARP请求环，半请求环，和半应答环。监测算法在此引擎中
的应用会在2.4节中进行讨论。在这些报文通过引擎监测后会将不合法结果汇报给警报模块，将合法结果添加到数据库中。
欺骗监测引擎会在下文中进行详细讨论。
2.4 欺骗检测引擎
	欺骗检测引擎是整个系统的核心部分。在2.2节中讨论的三种ARP报文会被引擎用作不同处理来判断一个尝试的攻击。
欺骗检测引擎基于以下规则：
规则A: “主机网卡会接受MAC地址与自己匹配的数据包，广播地址或者订阅的多播地址。网卡会将接受到的数据包传输到
IP层。IP层将只会接收IP地址与本机IP地址相同的数据包默默丢弃其他数据包。如果接受到的书举报是TCP数据包将会传输
到到TCP层。如果一个TCP SYN报文被接收到，当目的端口是打开着的主机会回复一个TCP SYN/ACK报文，当目的端口是关闭
的将会回复一个TCP RST报文“
规则B：”攻击者可以伪装假冒一台主机，但是没法阻止此主机自己发送ARP应答（或者其他任何报文）。这里的合法假设是
这台主机是在次网络上运行着的“

	注意这些规则其实是描述这些主机在收到一个数据包的时候给出的正确行为。给规则A一个例证，假设现在有一台主机
MAC地址 = X IP地址 = Y。如果这台主机收到一个目的MAC地址 = X，目的IP地址 = Z的包那么即使网卡会因为MAC地址
匹配而接收这个包，但是主机的网络协议栈也会因为目的IP地址不匹配而默默的丢弃这个数据包，不会向包的源头发送
任何错误信息。
	基于规则A，从主机网络协议栈的角度我们可以设想两种类型的探测包用来检测ARP欺骗攻击。
	a.正确的MAC地址-错我的IP数据包：目的MAC地址和host匹配但是目的IP地址和主机的任一网卡接口的IP地址不匹配。
	主机将会默默地丢弃这些包。
	b.正确的MAC地址-正确的IP数据包：木的MAC地址和IP地址与主机MAC地址IP地址相匹配，主机和主机的网络协议栈
	均会接收这个数据包。

我们从现在开始假设攻击者用的是正常的网络协议栈。我们的技术在现存的一些特化网络协议栈的表现会在2.5节进行讨论。
基于以上观察，我们将根据规则A构造出我们自己的数据包并将其发送到网络中。我们将会用在ARP应答中的地址信息来
验证应答的合法性。我们会用在ARP应答报文中的MAC和IP地址构造出TCP SYN包. 在TCP SYN包中的目的MAC地址和IP
是ARP应答报文中的源MAC地址和源IP，源MAC地址和源IP是运行欺骗检测引擎的主机的MAC地址和IP。TCP 包的目的端口
会基于允许/不允许的包过滤器及防火墙进行设置。如果在主机上安装了防火墙我们会选择"允许数据包通过的TCP端口“
（如 2.1节所述），如果没有安装任何防火墙我们将随便选择一个TCP端口。TCP SYN包头部的其他字段正常设置。

	当一个TCP SYN包被构造好并发送到ARP应答报文的源主机时，主机会基于规则A对报文进行应答。如果ARP应答报文
来自真实的主机网络协议栈，此主机回TCP RST报文（如果目的端口关闭）或者TCP SYN/ACK报文（如果目的端口打开）。
	
	如果ARP应答报文来自一个深怀恶意的主机根据跪着A他的网络协议栈将会丢弃这个TCP SYN包。基于欺骗检测引擎
是否收到任何关于此TCP SYN包的回复，就能判断出ARP应答报文的正确性。

	现在我们讨论如何将规则A和规则B用在一起来检测ARP攻击或攻击的尝试。请参考图2对于此算法流程的解说。
正如我们之前提到的ARP报文会被分为三种类型， 即满ARP请求环，半请求环，半应答环然后将其作为欺骗检测引擎
的输入。我们现在将讨论这三种报文在在ARP欺骗检测中的应用。

2.4.1 满ARP请求环 蛮ARP请求环由一个ARP请求和一个或多个ARP应答组成。我们将会根据ARP应答中的MAC地址和
IP地址构造TCP SYN包发往ARP应答源主机，就像2.4节提到的那样。基于规则A 我们知道只有真实的主机才会发回
TCP ACK/SYN 或者RST报文。我们会将这个结果作为正确结果存入数据库中。除了满ARP请求环类型的数据包，如果
有其他数据包的出现将会汇报给欺骗报警模块。
	注意我们不仅检测到ARP欺骗攻击而且还成功的检测到了正确的MAC地址与IP地址的映射关系，因为基于规则A只
有正确的主机的网络协议栈才会针对TCP SYN探针产生应答。

2.4.2 请求半环 请求半环当目的主机关机的时候也可能会出现。如果源ARP请求的源IP在数据库中是不存在的我们
将会构造TCP SYN包并发送，像2.4节中提到的那样。如果我们得到TCP SYN/ACK报文或者RST报文那么证实这个ARP
应答报文是虚假的并将其汇报给报警模块。作为检测欺骗攻击的替代方法我们会会向ARP回显报文的发送者发送ARP
请求报文，如果我们得到的结果与刚刚得到的结果不一致就立即产生警报。我们将会同时使用这两种方式进行ARP
欺骗攻击的检测。接下来的方法我们会假设攻击者用定制化的网络协议栈进行攻击，像2.5节中提到的那样。图一
是TCP 方法的简化流程图。
